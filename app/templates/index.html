{% extends "base.html" %}

{% block title %}Accueil ‚Äî Transcription Audio{% endblock %}

{% block content %}

<!-- FORMULAIRE -->
<form id="transcription-form" class="card">
    <label>Fichier audio</label>
    <input
        type="file"
        name="audio"
        accept=".mp3,.wav,.m4a,.flac"
        required
    >

    <label>R√©sum√© automatique</label>
    <select name="summary">
        <option value="false">Non</option>
        <option value="true">Oui</option>
    </select>

    <button type="submit">üéôÔ∏è Transcrire</button>
</form>

<!-- LOADER (sans pourcentage) -->
<div id="loader" class="loader hidden">
    <div class="progress-bar">
        <div class="progress-fill"></div>
    </div>
    <p>Traitement en cours‚Ä¶</p>
</div>

<!-- BO√éTE D‚ÄôERREUR -->
<div id="error-box" class="error hidden"></div>

<!-- SORTIES -->
<div class="console">
    <h2>Transcription</h2>
    <pre id="transcription-output"></pre>
</div>

<div class="console">
    <h2>R√©sum√©</h2>
    <pre id="summary-output"></pre>
</div>

<!-- SCRIPT -->
<script>
document.getElementById("transcription-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const loader = document.getElementById("loader");
    const transcriptionOutput = document.getElementById("transcription-output");
    const summaryOutput = document.getElementById("summary-output");
    const errorBox = document.getElementById("error-box");

    // Reset UI
    transcriptionOutput.textContent = "";
    summaryOutput.textContent = "";
    errorBox.textContent = "";
    errorBox.classList.add("hidden");

    loader.classList.remove("hidden");

    const formData = new FormData(this);
    const summary = formData.get("summary");

    try {
        const response = await fetch(`/transcribe?summary=${summary}`, {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || "Erreur serveur inconnue");
        }

        transcriptionOutput.textContent = data.transcription || "";
        summaryOutput.textContent = data.summary || "";

    } catch (error) {
        errorBox.textContent = "‚ùå " + error.message;
        errorBox.classList.remove("hidden");

    } finally {
        loader.classList.add("hidden");
    }
});
</script>

{% endblock %}

